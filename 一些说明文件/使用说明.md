# VDA5050 MQTT-TCP 桥接系统使用说明

## 📁 文件说明

- `start_vda5050_system.bat` - 系统启动脚本
- `stop_vda5050_system.bat` - 系统停止脚本  
- `sample_order.json` - 示例Order消息
- `使用说明.md` - 本文档

## 🚀 快速启动

### 1. 启动系统
双击运行 `start_vda5050_system.bat`

系统将按以下顺序启动：
1. **MQTT-TCP桥接服务器** (5秒后)
2. **AGV模拟器** (3秒后)  
3. **MQTT测试客户端**

### 2. 停止系统
双击运行 `stop_vda5050_system.bat`

## 📱 MQTTX 客户端配置

### 连接设置
```
服务器地址: broker.emqx.io
端口: 1883
客户端ID: mqttx_demo_client (避免冲突)
用户名: (留空)
密码: (留空)
```

### 📡 Topic 配置

#### 📤 发送 Order 消息 (下行)
**Topic:** `/uagv/v2/Demo_Manufacturer/AGV_001/order`
**消息内容:** 复制 `sample_order.json` 文件内容

#### 📥 接收 AGV 状态 (上行) - 需要订阅以下Topics:
1. **状态消息:** `/uagv/v2/Demo_Manufacturer/AGV_001/state`
2. **可视化消息:** `/uagv/v2/Demo_Manufacturer/AGV_001/visualization`  
3. **连接状态:** `/uagv/v2/Demo_Manufacturer/AGV_001/connection`

## 🔧 测试步骤

### 步骤1: 启动系统
1. 运行 `start_vda5050_system.bat`
2. 等待所有组件启动完成
3. 确认看到3个命令行窗口

### 步骤2: 配置MQTTX
1. 打开MQTTX客户端
2. 创建新连接，使用上述连接设置
3. 连接成功后，订阅上行Topics

### 步骤3: 验证状态接收
1. 系统启动后，AGV模拟器每2秒发送一次状态数据
2. 在MQTTX的订阅页面应该能看到定期收到的消息：
   - `state` - AGV当前状态
   - `visualization` - 位置和速度信息
   - `connection` - 连接状态

### 步骤4: 发送Order测试
1. 在MQTTX中切换到发布页面
2. Topic设置为: `/uagv/v2/Demo_Manufacturer/AGV_001/order`
3. 复制 `sample_order.json` 内容到消息框
4. 点击发送
5. 观察AGV模拟器窗口的反应和日志

## 📊 系统架构

```
MQTTX客户端 ←→ MQTT Broker (broker.emqx.io) ←→ VDA5050桥接服务器 ←→ AGV模拟器
     ↑                                                    ↑                    ↑
   用户界面                                           协议转换               模拟AGV设备
```

## 🔍 故障排除

### 问题1: AGV模拟器连接失败
**症状:** 看到 "连接失败 - 端口: 19xxx, 错误: [WinError 10061]"
**解决:** 确保MQTT-TCP桥接服务器已启动并等待足够时间

### 问题2: MQTTX收不到消息
**检查项:**
1. MQTTX是否正确连接到 broker.emqx.io
2. 是否订阅了正确的Topics
3. AGV模拟器是否成功连接到桥接服务器
4. 客户端ID是否与服务器冲突

### 问题3: Order消息发送失败
**检查项:**
1. Topic格式是否正确
2. JSON格式是否有效
3. 桥接服务器是否正常运行
4. AGV模拟器是否连接到对应端口

## 📋 日志文件位置

- **桥接服务器日志:** `logs/vda5050_server.log`
- **AGV模拟器日志:** `logs/agv_simulator.log`
- **MQTT测试客户端日志:** `logs/mqtt_test_client.log`
- **系统日志:** 各个命令行窗口的输出

## 🔗 相关端口

- **19205:** pick_drop动作
- **19206:** translate动作
- **19207:** turn动作  
- **19208:** reloc动作
- **19209:** pause动作
- **19210:** 其他动作
- **19301:** 状态上报

## 💡 提示

1. 首次运行建议先查看各个窗口的日志输出
2. 可以修改 `sample_order.json` 来测试不同的Order消息
3. AGV模拟器会随机生成位置和状态数据进行模拟
4. 系统支持多个MQTTX客户端同时连接 